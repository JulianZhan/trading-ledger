<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.trading.ledger.mapper.LedgerEntryMapper">

    <resultMap id="LedgerEntryResultMap" type="com.trading.ledger.domain.LedgerEntry">
        <id property="id" column="id"/>
        <result property="tradeId" column="trade_id"/>
        <result property="accountId" column="account_id"/>
        <result property="entryType" column="entry_type" typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>
        <result property="amount" column="amount"/>
        <result property="timestampNs" column="timestamp_ns"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <select id="sumEntriesByTradeId" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(CASE WHEN entry_type = 'DEBIT' THEN amount ELSE -amount END), 0)
        FROM ledger_entries
        WHERE trade_id = #{tradeId}
    </select>

    <insert id="insertAll">
        INSERT INTO ledger_entries (trade_id, account_id, entry_type, amount, timestamp_ns, created_at)
        VALUES
        <foreach collection="entries" item="entry" separator=",">
            (#{entry.tradeId}, #{entry.accountId}, #{entry.entryType}, #{entry.amount}, #{entry.timestampNs}, CURRENT_TIMESTAMP)
        </foreach>
    </insert>

    <select id="findByTradeId" resultMap="LedgerEntryResultMap">
        SELECT * FROM ledger_entries
        WHERE trade_id = #{tradeId}
        ORDER BY id
    </select>

    <select id="findByAccountId" resultMap="LedgerEntryResultMap">
        SELECT * FROM ledger_entries
        WHERE account_id = #{accountId}
        ORDER BY created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="calculatePositionsByAccountId" resultType="com.trading.ledger.dto.PositionResponse">
        SELECT
            t.account_id as accountId,
            t.symbol,
            SUM(CASE WHEN t.side = 'BUY' THEN t.quantity ELSE -t.quantity END) as quantity,
            CASE
                WHEN SUM(CASE WHEN t.side = 'BUY' THEN t.quantity ELSE -t.quantity END) != 0
                THEN SUM(CASE WHEN t.side = 'BUY' THEN t.quantity * t.price ELSE -t.quantity * t.price END) /
                     SUM(CASE WHEN t.side = 'BUY' THEN t.quantity ELSE -t.quantity END)
                ELSE 0
            END as averagePrice
        FROM trades t
        WHERE t.account_id = #{accountId}
        GROUP BY t.account_id, t.symbol
        HAVING SUM(CASE WHEN t.side = 'BUY' THEN t.quantity ELSE -t.quantity END) != 0
    </select>

</mapper>
